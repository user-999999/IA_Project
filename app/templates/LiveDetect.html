<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="refresh" content="180">
  <title>實時</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- js -->
  <script src="static/js/script.js" type="text/javascript"></script>

  <!-- css -->
  <link rel="stylesheet" href="static/css/style.css" />

  <!-- google fonts and css -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Madimi+One&display=swap" rel="stylesheet" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<style>
  body {
    background: white;
  }

  .loader {
    width: 250px;
    height: 50px;
    line-height: 50px;
    text-align: center;
    font-family: helvetica, arial, sans-serif;
    text-transform: uppercase;
    font-weight: 900;
    color: #ce4233;
    letter-spacing: 0.2em;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .loader::before,
  .loader::after {
    content: "";
    display: block;
    width: 15px;
    height: 15px;
    background: #ce4233;
    position: absolute;
    animation: load 0.9s infinite alternate ease-in-out;
  }

  .loader::before {
    top: 0;
  }

  .loader::after {
    bottom: 0;
  }

  @keyframes load {
    0% {
      left: 0;
      height: 30px;
      width: 15px;
    }

    50% {
      height: 8px;
      width: 40px;
    }

    100% {
      left: 235px;
      height: 30px;
      width: 15px;
    }
  }

  #content {
    display: none;
    /* 初始隱藏內容 */
  }
</style>

<script>
  function loadStream() {
    // 顯示加載動畫
    document.getElementById('loading').style.display = 'block';

    // 創建圖像對象以加載 RTSP 流
    const img = new Image();
    img.src = "{{ url_for('rtsp_feed') }}";

    img.onload = function () {
      // 隱藏加載動畫，顯示實時內容
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
      show_boxes(); // 加載完成後調用 show_boxes()
    };

    img.onerror = function () {
      // 處理錯誤情況
      alert('無法加載視頻流');
    };
  }
  function updateDetectionStatus(detectedItems) {
      const items = document.querySelectorAll('#detection-list li');

      items.forEach(item => {
          const itemName = item.getAttribute('data-item');
          if (detectedItems.includes(itemName)) {
              item.classList.remove('not-detected');
              item.classList.add('detected');
          } else {
              item.classList.remove('detected');
              item.classList.add('not-detected');
          }
      });
  }

  setInterval(() => {
      fetch('/live-detect')
          .then(response => response.json())
          .then(data => {
              const detectedItems = data.detected_items;
              updateDetectionStatus(detectedItems);
          })
          .catch(error => console.error('Error fetching detection data:', error));
  }, 5000);

  window.onload = loadStream; // 當頁面加載時開始加載流
</script>

</head>

<body>
  <!-- loading message -->
  <div class="loader" id="loading">Loading...</div>

  <div id="content">
    <div>
      <div id="header">
        <span style="font-size: 30px; cursor: pointer" onclick="openMenu()"> &#9776; </span>
      </div>
      <div class="setMenu" id="menu">
        <a href="javascript:void(0)" class="close" onclick="closeMenu()">&times;</a>
        <a href="/">首頁</a>
        <a href="/liveDetect">實時檢測</a>
        <a href="/vidpred">影片檢測</a>
        <a href="/objectDetection">圖像檢測</a>
      </div>
    </div>

    <!--  -->

    <section class="content" style="margin-top: 80px;">
      <div class="container-fluid">
        <div class="row">
          <section class="col-lg-9 connectedSortable">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Object Detection
                </h3>
              </div>

              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="revenue-chart" style="position: relative; height: 700px;">
                    <div class="video-container flex-grow-1">
                      <img src="{{ url_for('rtsp_feed') }}" alt="RTSP Stream" style="width: 90%;" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="col-lg-3 connectedSortable">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-chart-pie mr-1"></i>
                  Object Detection Results
                </h3>
              </div>

              <div class="card-body">
                <div class="tab-content p-0">
                  <div class="chart tab-pane active" id="revenue-chart" style="position: relative; height: 695px;">

                    <ul id="detection-list" class="detection-list text-center">
                      <li data-item="rock" class="not-detected">rock</li>
                      <li data-item="slurry-soil" class="not-detected">slurry-soil</li>
                      <li data-item="Non-inert" class="not-detected">Non-inert</li>
                      <li data-item="inert" class="not-detected">inert</li>
                      <li data-item="slurry; wet" class="not-detected">wet</li>
                      <li data-item="truck" class="not-detected">truck</li>
                      <li data-item="person" class="not-detected">worker(test)</li>
                    </ul>

                    <div id="yes-no-container" class="text-center">
                      <div id="yes-no-box" class="not-detected">No</div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>

    <footer class="bg-dark py-4 mt-auto">
      <div class="text-center justify-content-between flex-column flex-sm-row">
        <div class="small m-0 text-white"> &copy; Chun Wo Construction and Engineering Co. Ltd. </div>
      </div>
    </footer>

</body>

</html>